---@class Buff:TickObject
local Buff = Class("Buff", TickObject)

---@param buffManager BuffManager
function Buff:Init(buffManager, buffId)
	Buff.super.Init(self)
	---@type BuffManager
	self.buffManager = buffManager
	self.buffId = buffId
	self.cfgBuffData = CfgBuff.get_by_id(buffId)
	---@type BuffCache[]
	self.buffCacheList = {} -- 因为有些buff可以同时存在多个，但效果只有一个生效,效果不累加
	---@field EffectBase[]
	self.effectList = {} -- 一个buff可能有多个特效
end

function Buff:CreateBuffCache(duration, sourceUnit, sourceSpell, argDict)
	---@type BuffCache
	local buffCache = BuffCache.New()
	buffCache.duration = duration
	buffCache.remainDuration = duration
	buffCache.sourceUnit = sourceUnit
	buffCache.sourceSpell = sourceSpell
	buffCache.argDict = argDict
	table.insert(self.buffCacheList, buffCache)
	if #self.buffCacheList == 1 then
		-- 第一个的时候才添加
		self:AddEffects()
		self:AddPropertyDict()
		self:AddTriggerSpell()
		self.buffManager:AddState(self.cfgBuffData.state)
	end
	return self
end

function Buff:__Update(deltaTime, unscaledDeltaTime)
	Buff.super.__Update(self, deltaTime, unscaledDeltaTime)
	for i = #self.buffCacheList, 1, -1 do
		local buffCache = self.buffCacheList[i]
		buffCache.remainDuration = buffCache.remainDuration - deltaTime
		if buffCache.remainDuration <= 0 then
			table.remove(self.buffCacheList, i)
		end
	end
	if #self.buffCacheList == 0 then
		self.buffManager:RemoveBuffByBuff(self)
	end
end

function Buff:RemoveBuffCache(sourceUnitGuid, sourceSpellGuid)
	for i = #self.buffCacheList, 1, -1 do
		local buffCache = self.buffCacheList[i]
		local isThisUnit = not sourceUnitGuid or (buffCache.sourceUnit and buffCache.sourceUnit:GetGuid() == sourceUnitGuid)
		local isThisSpell = not sourceSpellGuid or (buffCache.sourceSpell and buffCache.sourceSpell:GetGuid() == sourceSpellGuid)
		if isThisUnit and isThisSpell then
			table.remove(self.buffCacheList, i)
		end
	end
	if #self.buffCacheList == 0 then
		self.buffManager:RemoveBuffByBuff(self)
	end
end

function Buff:AddEffects()
	local effectIds = self.cfgBuffData.effectIds
	if table.IsNilOrEmpty(effectIds) then
		return
	end
	for _, effectId in ipairs(effectIds) do
		local cfgEffectData = CfgEffect.get_by_id(effectId)
		local effect = global.client.combat.effectManager:CreateAttachEffect(effectId, self.buffManager.unit, cfgEffectData.duration) -- TODO 如何初始化effectBase
		table.insert(self.effectList, effect)
	end
end

function Buff:RemoveEffects()
	for _, effect in ipairs(self.effectList) do
		global.client.combat.effectManager:RemoveEffectEntity(effect.key)
	end
end

function Buff:AddPropertyDict()
	local newPropertyDict = self.cfgBuffData.propertyDict and DoerAttrParserUtil.ConvertTableWithTypeString(self.cfgBuffData.property_dict) or {}
	if table.Count(newPropertyDict) > 0 then
		local propertyComp = self.buffManager.unit.propertyComp
		propertyComp:StartChange()
		propertyComp:AddPropSet(newPropertyDict, "buff", self:GetGuid())
		propertyComp:EndChange()
	end
end

function Buff:RemovePropertyDict()
	local newPropertyDict = self.cfgBuffData.propertyDict and DoerAttrParserUtil.ConvertTableWithTypeString(self.cfgBuffData.propertyDict) or {}
	if table.Count(newPropertyDict) > 0 then
		local propertyComp = self.cfgBuffData.unit.propertyComp
		propertyComp:StartChange()
		propertyComp:RemovePropSet("buff", self:GetGuid())
		propertyComp:EndChange()
	end
end

function Buff:AddTriggerSpell()
	local triggerSpellId = self.cfgBuffData.triggerSpellId
	if table.IsNilOrEmpty(triggerSpellId) then
		return
	end
	local spell = global.client.combat.spellManager:CastSpell(self.buffCacheList[1].sourceUnit or self.buffManager.unit, triggerSpellId, self.buffManager.unit)
	self.triggerSpellGuid = spell:GetGuid()
end

function Buff:RemoveTriggerSpell()
	if self.triggerSpellGuid then
		local spell = global.client.combat.spellManager:GetSpell(self.triggerSpellGuid)
		if not spell then
			return
		end
		if spell.OnBuffRemove then
			spell:OnBuffRemove(self)
			return
		end
		global.client.combat.spellManager:RemoveSpell(self.triggerSpellGuid)
	end
end

function Buff:__Destroy()
	Buff.super.__Destroy(self)
	self:RemoveEffects()
	self:RemovePropertyDict()
	self:RemoveTriggerSpell()
	self.buffManager:RemoveState(self.cfgBuffData.state)
end

return Buff